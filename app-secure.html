<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Clients - Base de donnÃ©es</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #1c2128;
            --bg-hover: #21262d;
            --bg-input: #0d1117;
            --green-bright: #3fb950;
            --green-default: #238636;
            --green-dim: #196c2e;
            --green-glow: rgba(63, 185, 80, 0.4);
            --green-subtle: rgba(63, 185, 80, 0.15);
            --yellow: #d29922;
            --yellow-bright: #e3b341;
            --red: #f85149;
            --red-bright: #ff7b72;
            --blue: #58a6ff;
            --blue-bright: #79c0ff;
            --purple: #a371f7;
            --purple-bright: #d2a8ff;
            --cyan: #56d4dd;
            --cyan-bright: #76e4f7;
            --orange: #db6d28;
            --pink: #db61a2;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --text-bright: #f0f6fc;
            --border: #30363d;
            --glow-green: 0 0 20px rgba(63, 185, 80, 0.4);
            --glow-green-soft: 0 0 10px rgba(63, 185, 80, 0.2);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
            pointer-events: none;
            z-index: 9999;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 {
            color: var(--green-bright);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: var(--glow-green);
        }
        h1::before { content: '> '; color: var(--text-muted); }
        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: border-color 0.3s;
        }
        .card:hover { border-color: var(--green-dim); }
        h2 {
            color: var(--cyan);
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        h2::before { content: '# '; color: var(--text-muted); }
        h3 {
            color: var(--green-bright);
            margin-top: 20px;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        h3::before { content: '## '; color: var(--text-muted); }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--yellow-bright);
            font-weight: 600;
            font-size: 0.9em;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--green-bright);
            box-shadow: 0 0 0 3px var(--green-subtle);
        }
        input::placeholder, textarea::placeholder { color: var(--text-muted); }
        textarea { resize: vertical; min-height: 120px; }
        .btn {
            background: var(--green-default);
            color: var(--text-bright);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            background: var(--green-bright);
            box-shadow: var(--glow-green);
            transform: translateY(-1px);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-danger { background: var(--red); }
        .btn-danger:hover { background: var(--red-bright); box-shadow: 0 0 20px rgba(248,81,73,0.4); }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); border-color: var(--green-bright); box-shadow: var(--glow-green-soft); }
        .btn-purple { background: var(--purple); }
        .btn-purple:hover { background: var(--purple-bright); box-shadow: 0 0 20px rgba(163,113,247,0.4); }
        .btn-cyan { background: #0d7377; color: var(--cyan-bright); }
        .btn-cyan:hover { background: var(--cyan); color: var(--bg-primary); }
        .search-box { margin-bottom: 20px; }
        .search-box input {
            padding-left: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236e7681' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
        }
        .clients-list { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
        .client-button {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px 20px;
            color: var(--green-bright);
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-family: inherit;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .client-button:hover {
            border-color: var(--green-bright);
            background: var(--bg-hover);
            box-shadow: var(--glow-green-soft);
            transform: translateX(4px);
        }
        .client-button.active { border-color: var(--green-bright); background: var(--bg-hover); box-shadow: var(--glow-green); }
        .client-button::before { content: 'â”œâ”€â”€ '; color: var(--text-muted); font-weight: normal; }
        .client-arrow { color: var(--cyan); font-size: 1.1em; transition: transform 0.3s; }
        .client-button:hover .client-arrow { transform: translateX(4px); }
        .client-details {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--green-bright);
            border-radius: 8px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: var(--glow-green-soft);
        }
        .client-details.show { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .detail-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--green-bright);
            text-shadow: var(--glow-green-soft);
        }
        .detail-title::before { content: '> '; color: var(--text-muted); }
        .detail-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .client-info { color: var(--text-primary); margin-bottom: 12px; line-height: 1.8; font-size: 0.95em; }
        .client-info strong { color: var(--cyan); display: inline-block; min-width: 120px; }
        .client-notes {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 3px solid var(--green-bright);
        }
        .notes-label { color: var(--yellow-bright); font-weight: 600; margin-bottom: 10px; font-size: 0.9em; }
        .notes-content { white-space: pre-wrap; font-family: inherit; color: var(--text-secondary); line-height: 1.7; }
        .files-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); }
        .files-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .files-title { color: var(--purple); font-size: 1.1em; }
        .files-title::before { content: 'ğŸ“ '; }
        .file-upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .file-upload-zone:hover, .file-upload-zone.dragover {
            border-color: var(--green-bright);
            background: var(--green-subtle);
        }
        .file-upload-zone.dragover { box-shadow: var(--glow-green); }
        .upload-icon { font-size: 2.5em; margin-bottom: 10px; }
        .upload-text { color: var(--text-secondary); margin-bottom: 10px; }
        .upload-hint { color: var(--text-muted); font-size: 0.85em; }
        .files-list { display: flex; flex-direction: column; gap: 8px; }
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        .file-item:hover { border-color: var(--cyan); }
        .file-info { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
        .file-icon { font-size: 1.3em; }
        .file-name { color: var(--text-primary); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-size { color: var(--text-muted); font-size: 0.85em; margin-left: 10px; }
        .file-actions { display: flex; gap: 8px; }
        .file-btn { padding: 6px 12px; font-size: 0.85em; border-radius: 4px; }
        .no-files { text-align: center; padding: 30px; color: var(--text-muted); }
        .no-files::before { content: 'ğŸ“­ '; font-size: 1.5em; }
        .edit-form { background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
        .edit-form .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .edit-form .form-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .status-success { background: var(--green-dim); color: var(--green-bright); border: 1px solid var(--green-default); }
        .status-error { background: rgba(248,81,73,0.2); color: var(--red-bright); border: 1px solid var(--red); }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal { transform: scale(1); }
        .modal-title { color: var(--yellow-bright); font-size: 1.3em; margin-bottom: 15px; }
        .modal-content { color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .export-section { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .header-title { color: var(--green-bright); font-size: 1.8em; text-shadow: var(--glow-green); }
        .header-title::before { content: '> '; color: var(--text-muted); }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .user-info { color: var(--text-secondary); font-size: 0.9em; }
        .user-info span { color: var(--cyan); font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .stat-card:hover { border-color: var(--green-bright); box-shadow: var(--glow-green-soft); }
        .stat-value { font-size: 2em; font-weight: bold; color: var(--green-bright); text-shadow: var(--glow-green-soft); }
        .stat-label { color: var(--text-muted); font-size: 0.85em; margin-top: 5px; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.5; }
        .empty-state-text { font-size: 1.1em; margin-bottom: 10px; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.5em; }
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .detail-header { flex-direction: column; gap: 15px; }
            .detail-actions { width: 100%; justify-content: center; }
            .btn { padding: 10px 16px; font-size: 13px; }
        }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--green-dim); }
        ::selection { background: var(--green-subtle); color: var(--text-bright); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">Gestion de Clients</div>
            <div class="header-actions">
                <div class="user-info">ConnectÃ© : <span id="currentUser">-</span></div>
                <button class="btn btn-secondary" onclick="logout()">ğŸšª DÃ©connexion</button>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalClients">0</div>
                <div class="stat-label">Clients</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalFiles">0</div>
                <div class="stat-label">Fichiers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lastUpdate">-</div>
                <div class="stat-label">DerniÃ¨re mise Ã  jour</div>
            </div>
        </div>
        <div class="card">
            <h2>Ajouter un client</h2>
            <form id="clientForm">
                <div class="edit-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">ğŸ‘¤ Nom *</label>
                            <input type="text" id="nom" required placeholder="Nom du client">
                        </div>
                        <div class="form-group">
                            <label for="email">ğŸ“§ Email</label>
                            <input type="email" id="email" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label for="telephone">ğŸ“± TÃ©lÃ©phone</label>
                            <input type="tel" id="telephone" placeholder="06 12 34 56 78">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">ğŸ“ Notes</label>
                        <textarea id="notes" placeholder="Informations supplÃ©mentaires..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">â†©ï¸ RÃ©initialiser</button>
                        <button type="submit" class="btn">â• Ajouter le client</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="card">
            <h2>Liste des clients</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Rechercher un client..." onkeyup="filterClients()">
            </div>
            <div id="clientsList" class="clients-list"></div>
        </div>
        <div id="clientDetails" class="client-details"></div>
        <div class="card">
            <h2>Import / Export</h2>
            <div class="export-section">
                <button class="btn btn-secondary" onclick="exportData('json')">ğŸ“„ Export JSON</button>
                <button class="btn btn-secondary" onclick="exportData('csv')">ğŸ“Š Export CSV</button>
                <button class="btn btn-secondary" onclick="exportData('txt')">ğŸ“ Export TXT</button>
                <button class="btn btn-secondary" onclick="exportData('html')">ğŸŒ Export HTML</button>
                <button class="btn btn-purple" onclick="exportDataWithFiles()">ğŸ“¦ Export complet (ZIP)</button>
                <label class="btn btn-cyan" style="cursor: pointer;">
                    ğŸ“¥ Import JSON
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </label>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">âš ï¸ Confirmation</div>
            <div class="modal-content" id="confirmMessage">ÃŠtes-vous sÃ»r ?</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Annuler</button>
                <button class="btn btn-danger" id="confirmBtn" onclick="confirmAction()">Confirmer</button>
            </div>
        </div>
    </div>
    <div id="statusMessage" class="status-message" style="display: none;"></div>
    <script>
        const API_URL = '/api/clients';
        const FILES_API_URL = '/files';
        const SESSION_KEY = 'gestion-clients-token';
        let clients = [];
        let selectedClientId = null;
        let pendingAction = null;

        checkAuth();

        async function checkAuth() {
            const tokenData = localStorage.getItem(SESSION_KEY) || sessionStorage.getItem(SESSION_KEY);
            if (!tokenData) { window.location.href = 'login.html'; return; }
            try {
                const session = JSON.parse(tokenData);
                if (Date.now() >= session.expiresAt) { logout(); return; }
                const response = await fetch('/auth/verify', { headers: { 'Authorization': `Bearer ${session.token}` } });
                const data = await response.json();
                if (!data.success) { logout(); return; }
                document.getElementById('currentUser').textContent = session.username;
                loadClients();
            } catch (error) { console.error('Erreur auth:', error); logout(); }
        }

        function logout() {
            localStorage.removeItem(SESSION_KEY);
            sessionStorage.removeItem(SESSION_KEY);
            window.location.href = 'login.html';
        }

        async function loadClients() {
            try {
                const response = await fetch(API_URL);
                clients = await response.json();
                updateStats();
                renderClients();
            } catch (error) { console.error('Erreur:', error); showStatus('âŒ Erreur de chargement', true); }
        }

        function updateStats() {
            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR');
            let totalFiles = 0;
            clients.forEach(c => { if (c.filesCount) totalFiles += c.filesCount; });
            document.getElementById('totalFiles').textContent = totalFiles || 'â€”';
        }

        function renderClients() {
            const container = document.getElementById('clientsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = clients.filter(c =>
                c.nom.toLowerCase().includes(searchTerm) ||
                (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                (c.telephone && c.telephone.includes(searchTerm))
            );
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><div class="empty-state-text">Aucun client trouvÃ©</div></div>';
                return;
            }
            container.innerHTML = filtered.map(client => `
                <button class="client-button ${selectedClientId === client.id ? 'active' : ''}" onclick="selectClient('${client.id}')">
                    <span>${client.nom}</span>
                    <span class="client-arrow">â†’</span>
                </button>
            `).join('');
        }

        function filterClients() { renderClients(); }

        async function selectClient(clientId) {
            selectedClientId = clientId;
            renderClients();
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            const details = document.getElementById('clientDetails');
            details.innerHTML = `
                <div class="detail-header">
                    <div class="detail-title">${client.nom}</div>
                    <div class="detail-actions">
                        <button class="btn btn-secondary" onclick="editClient('${client.id}')">âœï¸ Modifier</button>
                        <button class="btn btn-purple" onclick="exportSingleClient('${client.id}')">ğŸ“¦ Exporter</button>
                        <button class="btn btn-danger" onclick="confirmDelete('${client.id}')">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
                <div class="client-info"><strong>ğŸ“§ Email :</strong> ${client.email || 'â€”'}</div>
                <div class="client-info"><strong>ğŸ“± TÃ©lÃ©phone :</strong> ${client.telephone || 'â€”'}</div>
                <div class="client-info"><strong>ğŸ“… AjoutÃ© le :</strong> ${client.dateAjout || 'â€”'}</div>
                <div class="client-info"><strong>ğŸ†” ID :</strong> <code>${client.id}</code></div>
                ${client.notes ? `<div class="client-notes"><div class="notes-label">ğŸ“ Notes</div><div class="notes-content">${escapeHtml(client.notes)}</div></div>` : ''}
                <div class="files-section">
                    <div class="files-header"><div class="files-title">Fichiers attachÃ©s</div></div>
                    <div class="file-upload-zone" id="uploadZone" ondrop="handleDrop(event, '${client.id}')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">Glissez-dÃ©posez des fichiers ici</div>
                        <div class="upload-hint">ou cliquez pour parcourir</div>
                        <input type="file" id="fileInput" multiple style="display: none;" onchange="uploadFiles(event, '${client.id}')">
                    </div>
                    <div id="filesList" class="files-list"><div class="no-files">Chargement...</div></div>
                </div>
            `;
            details.classList.add('show');
            loadClientFiles(clientId);
        }

        async function loadClientFiles(clientId) {
            try {
                const response = await fetch(`${FILES_API_URL}/${clientId}`);
                const data = await response.json();
                const container = document.getElementById('filesList');
                if (!data.files || data.files.length === 0) {
                    container.innerHTML = '<div class="no-files">Aucun fichier</div>';
                    return;
                }
                container.innerHTML = data.files.map(file => `
                    <div class="file-item">
                        <div class="file-info">
                            <span class="file-icon">${getFileIcon(file.originalname)}</span>
                            <span class="file-name">${file.originalname}</span>
                            <span class="file-size">${formatFileSize(file.size)}</span>
                        </div>
                        <div class="file-actions">
                            <a href="${file.path}" target="_blank" class="btn btn-secondary file-btn">ğŸ‘ï¸</a>
                            <a href="${file.path}" download class="btn btn-secondary file-btn">â¬‡ï¸</a>
                            <button class="btn btn-danger file-btn" onclick="deleteFile('${clientId}', '${file.filename}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) { document.getElementById('filesList').innerHTML = '<div class="no-files">Erreur</div>'; }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = { pdf:'ğŸ“•', doc:'ğŸ“˜', docx:'ğŸ“˜', xls:'ğŸ“—', xlsx:'ğŸ“—', ppt:'ğŸ“™', pptx:'ğŸ“™', txt:'ğŸ“„', jpg:'ğŸ–¼ï¸', jpeg:'ğŸ–¼ï¸', png:'ğŸ–¼ï¸', gif:'ğŸ–¼ï¸', mp3:'ğŸµ', mp4:'ğŸ¬', zip:'ğŸ“¦', rar:'ğŸ“¦', js:'ğŸ’»', py:'ğŸ', html:'ğŸŒ', css:'ğŸ¨', json:'ğŸ“‹' };
            return icons[ext] || 'ğŸ“';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
        async function handleDrop(e, clientId) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) await uploadFilesArray(e.dataTransfer.files, clientId); }
        async function uploadFiles(e, clientId) { if (e.target.files.length > 0) await uploadFilesArray(e.target.files, clientId); }

        async function uploadFilesArray(files, clientId) {
            const formData = new FormData();
            for (let file of files) formData.append('files', file);
            try {
                showStatus('â³ Upload en cours...', false);
                const response = await fetch(`${FILES_API_URL}/${clientId}`, { method: 'POST', body: formData });
                if (response.ok) { showStatus(`âœ… ${files.length} fichier(s) uploadÃ©(s)`); loadClientFiles(clientId); }
                else throw new Error('Erreur');
            } catch (error) { showStatus('âŒ Erreur upload', true); }
        }

        async function deleteFile(clientId, filename) {
            if (!confirm('Supprimer ce fichier ?')) return;
            try {
                const response = await fetch(`${FILES_API_URL}/${clientId}/${filename}`, { method: 'DELETE' });
                if (response.ok) { showStatus('âœ… Fichier supprimÃ©'); loadClientFiles(clientId); }
            } catch (error) { showStatus('âŒ Erreur', true); }
        }

        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const client = {
                nom: document.getElementById('nom').value.trim(),
                email: document.getElementById('email').value.trim(),
                telephone: document.getElementById('telephone').value.trim(),
                notes: document.getElementById('notes').value.trim(),
                dateAjout: new Date().toLocaleDateString('fr-FR')
            };
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(client) });
                if (response.ok) { showStatus('âœ… Client ajoutÃ©'); resetForm(); loadClients(); }
            } catch (error) { showStatus('âŒ Erreur', true); }
        });

        function resetForm() { document.getElementById('clientForm').reset(); }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            const details = document.getElementById('clientDetails');
            details.innerHTML = `
                <div class="detail-header"><div class="detail-title">Modifier : ${client.nom}</div></div>
                <form class="edit-form" onsubmit="saveClient(event, '${clientId}')">
                    <div class="form-row">
                        <div class="form-group"><label>ğŸ‘¤ Nom *</label><input type="text" id="editNom" value="${escapeHtml(client.nom)}" required></div>
                        <div class="form-group"><label>ğŸ“§ Email</label><input type="email" id="editEmail" value="${escapeHtml(client.email || '')}"></div>
                        <div class="form-group"><label>ğŸ“± TÃ©lÃ©phone</label><input type="tel" id="editTelephone" value="${escapeHtml(client.telephone || '')}"></div>
                    </div>
                    <div class="form-group"><label>ğŸ“ Notes</label><textarea id="editNotes">${escapeHtml(client.notes || '')}</textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="selectClient('${clientId}')">âŒ Annuler</button>
                        <button type="submit" class="btn">ğŸ’¾ Enregistrer</button>
                    </div>
                </form>
            `;
        }

        async function saveClient(e, clientId) {
            e.preventDefault();
            const client = {
                nom: document.getElementById('editNom').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                telephone: document.getElementById('editTelephone').value.trim(),
                notes: document.getElementById('editNotes').value.trim()
            };
            try {
                const response = await fetch(`${API_URL}/${clientId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(client) });
                if (response.ok) { showStatus('âœ… Client modifiÃ©'); loadClients(); setTimeout(() => selectClient(clientId), 100); }
            } catch (error) { showStatus('âŒ Erreur', true); }
        }

        function confirmDelete(clientId) {
            const client = clients.find(c => c.id === clientId);
            pendingAction = () => deleteClient(clientId);
            document.getElementById('confirmMessage').innerHTML = `Supprimer <strong>${client.nom}</strong> et tous ses fichiers ?`;
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('show'); pendingAction = null; }
        function confirmAction() { if (pendingAction) { pendingAction(); closeConfirmModal(); } }

        async function deleteClient(clientId) {
            try {
                const response = await fetch(`${API_URL}/${clientId}`, { method: 'DELETE' });
                if (response.ok) { showStatus('âœ… Client supprimÃ©'); document.getElementById('clientDetails').classList.remove('show'); selectedClientId = null; loadClients(); }
            } catch (error) { showStatus('âŒ Erreur', true); }
        }

        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        function showStatus(message, isError = false) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
            status.style.display = 'block';
            setTimeout(() => { status.style.display = 'none'; }, 4000);
        }

        async function exportData(format) {
            try {
                let content, filename, mimeType;
                const date = new Date().toISOString().split('T')[0];
                switch(format) {
                    case 'json':
                        content = JSON.stringify(clients, null, 2);
                        filename = `clients-${date}.json`;
                        mimeType = 'application/json';
                        break;
                    case 'csv':
                        const headers = ['Nom', 'Email', 'TÃ©lÃ©phone', 'Notes', 'Date Ajout', 'ID'];
                        const rows = clients.map(c => [escapeCsv(c.nom), escapeCsv(c.email), escapeCsv(c.telephone), escapeCsv(c.notes), escapeCsv(c.dateAjout), c.id]);
                        content = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                        filename = `clients-${date}.csv`;
                        mimeType = 'text/csv;charset=utf-8;';
                        break;
                    case 'txt':
                        content = clients.map(c => `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ‘¤ ${c.nom}\nğŸ“§ ${c.email || 'â€”'}\nğŸ“± ${c.telephone || 'â€”'}\nğŸ“… ${c.dateAjout || 'â€”'}\n${c.notes ? 'ğŸ“ ' + c.notes + '\n' : ''}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`).join('\n\n');
                        filename = `clients-${date}.txt`;
                        mimeType = 'text/plain;charset=utf-8;';
                        break;
                    case 'html':
                        content = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>Export Clients</title><style>body{font-family:system-ui;background:#0d1117;color:#e6edf3;padding:40px}h1{color:#3fb950}.client{background:#161b22;padding:20px;margin:15px 0;border-radius:8px;border:1px solid #30363d}.client h2{color:#56d4dd;margin:0 0 10px 0}.label{color:#8b949e}</style></head><body><h1>ğŸ“‹ Liste des Clients</h1><p>Export du ${new Date().toLocaleString('fr-FR')}</p>${clients.map(c => `<div class="client"><h2>${escapeHtml(c.nom)}</h2><div><span class="label">ğŸ“§ Email:</span> ${escapeHtml(c.email) || 'â€”'}</div><div><span class="label">ğŸ“± TÃ©l:</span> ${escapeHtml(c.telephone) || 'â€”'}</div><div><span class="label">ğŸ“… AjoutÃ©:</span> ${c.dateAjout || 'â€”'}</div>${c.notes ? '<div><span class="label">ğŸ“ Notes:</span><br>' + escapeHtml(c.notes) + '</div>' : ''}</div>`).join('')}</body></html>`;
                        filename = `clients-${date}.html`;
                        mimeType = 'text/html;charset=utf-8;';
                        break;
                }
                const blob = new Blob([content], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                showStatus(`âœ… Export ${format.toUpperCase()} rÃ©ussi !`);
            } catch (error) { showStatus('âŒ Erreur export', true); }
        }

        function escapeCsv(str) {
            if (str === null || str === undefined) return '';
            str = String(str);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) return '"' + str.replace(/"/g, '""') + '"';
            return str;
        }

        async function exportDataWithFiles() {
            try {
                showStatus('â³ PrÃ©paration export...', false);
                const response = await fetch('/export-all', { method: 'GET', headers: { 'Accept': 'application/zip' } });
                if (!response.ok) throw new Error(`Erreur ${response.status}`);
                const blob = await response.blob();
                if (blob.size < 1000) throw new Error('ZIP invalide');
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `export-complet-clients-${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                showStatus(`âœ… Export complet rÃ©ussi !`);
            } catch (error) { showStatus(`âŒ Erreur: ${error.message}`, true); }
        }

        window.exportSingleClient = async function(clientId) {
            try {
                showStatus('â³ Export en cours...', false);
                const response = await fetch(`${API_URL}/${clientId}`);
                const client = await response.json();
                const zip = new JSZip();
                const date = new Date().toISOString().split('T')[0];
                const safeName = client.nom.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_');
                zip.file('client.json', JSON.stringify(client, null, 2));
                zip.file('client.txt', `FICHE CLIENT\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ‘¤ ${client.nom}\nğŸ“§ ${client.email || 'â€”'}\nğŸ“± ${client.telephone || 'â€”'}\nğŸ“… ${client.dateAjout || 'â€”'}\nğŸ†” ${client.id}\n${client.notes ? '\nğŸ“ Notes:\n' + client.notes : ''}`);
                let totalFiles = 0;
                try {
                    const filesResponse = await fetch(`${FILES_API_URL}/${client.id}`);
                    if (filesResponse.ok) {
                        const filesData = await filesResponse.json();
                        if (filesData.files && filesData.files.length > 0) {
                            const filesFolder = zip.folder('fichiers');
                            for (const file of filesData.files) {
                                try {
                                    const fileResponse = await fetch(file.path);
                                    if (fileResponse.ok) { filesFolder.file(file.originalname, await fileResponse.blob()); totalFiles++; }
                                } catch (e) {}
                            }
                        }
                    }
                } catch (e) {}
                const zipBlob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 9 } });
                const url = window.URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${safeName}-${date}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                showStatus(`âœ… Export: ${client.nom} + ${totalFiles} fichier(s)`);
            } catch (error) { showStatus('âŒ Erreur export', true); }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const imported = JSON.parse(await file.text());
                if (!Array.isArray(imported)) throw new Error('Format invalide');
                let count = 0;
                for (const client of imported) {
                    if (client.nom) {
                        await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nom: client.nom, email: client.email || '', telephone: client.telephone || '', notes: client.notes || '', dateAjout: client.dateAjout || new Date().toLocaleDateString('fr-FR') }) });
                        count++;
                    }
                }
                showStatus(`âœ… ${count} client(s) importÃ©(s)`);
                loadClients();
            } catch (error) { showStatus('âŒ Erreur import', true); }
            event.target.value = '';
        }
    </script>
</body>
</html>
