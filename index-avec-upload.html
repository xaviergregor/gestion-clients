<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Clients - Base de donn√©es</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #282A36;
            color: #F8F8F2;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #FF79C6;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(255, 121, 198, 0.5);
        }

        .card {
            background: #44475A;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 25px;
            border: 1px solid #6272A4;
        }

        h2 {
            color: #8BE9FD;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        h3 {
            color: #50FA7B;
            margin-top: 20px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #F1FA8C;
            font-weight: 600;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #6272A4;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #282A36;
            color: #F8F8F2;
            font-family: 'Courier New', monospace;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #BD93F9;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }

        .btn {
            background: #BD93F9;
            color: #282A36;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .btn:hover {
            background: #FF79C6;
            box-shadow: 0 0 15px rgba(189, 147, 249, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            background: #282A36;
        }

        .clients-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .client-button {
            background: #44475A;
            border: 2px solid #6272A4;
            border-radius: 6px;
            padding: 15px 20px;
            color: #FF79C6;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-button:hover {
            border-color: #BD93F9;
            background: #282A36;
            box-shadow: 0 0 15px rgba(189, 147, 249, 0.4);
            transform: translateX(5px);
        }

        .client-button.active {
            border-color: #FF79C6;
            background: #282A36;
            box-shadow: 0 0 20px rgba(255, 121, 198, 0.5);
        }

        .client-arrow {
            color: #8BE9FD;
            font-size: 1.2em;
        }

        .client-details {
            display: none;
            background: #282A36;
            border: 2px solid #BD93F9;
            border-radius: 6px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 0 25px rgba(189, 147, 249, 0.3);
        }

        .client-details.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #6272A4;
        }

        .detail-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #FF79C6;
            text-shadow: 0 0 5px rgba(255, 121, 198, 0.3);
        }

        .detail-actions {
            display: flex;
            gap: 10px;
        }

        .client-info {
            color: #F8F8F2;
            margin-bottom: 15px;
            line-height: 1.8;
            font-size: 1em;
        }

        .client-info strong {
            color: #8BE9FD;
            display: inline-block;
            min-width: 120px;
        }

        .client-notes {
            background: #44475A;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #50FA7B;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.8;
            color: #F1FA8C;
        }

        .notes-label {
            color: #8BE9FD;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
        }

        .btn-delete {
            background: #FF5555;
            color: #F8F8F2;
        }

        .btn-delete:hover {
            background: #FF6E67;
            box-shadow: 0 0 15px rgba(255, 85, 85, 0.6);
        }

        .btn-edit {
            background: #8BE9FD;
            color: #282A36;
        }

        .btn-edit:hover {
            background: #50FA7B;
            box-shadow: 0 0 15px rgba(139, 233, 253, 0.6);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6272A4;
            grid-column: 1 / -1;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-box {
            background: #282A36;
            color: #F8F8F2;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            flex: 1;
            min-width: 150px;
            border: 2px solid #BD93F9;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #FF79C6;
        }

        .stat-label {
            font-size: 0.9em;
            color: #8BE9FD;
            margin-top: 5px;
        }

        .note-hint {
            font-size: 0.85em;
            color: #6272A4;
            margin-top: 5px;
            font-style: italic;
        }

        .status-message {
            background: #50FA7B;
            color: #282A36;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }

        .status-message.error {
            background: #FF5555;
            color: #F8F8F2;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #8BE9FD;
        }

        .alphabet-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .alphabet-btn {
            background: #44475A;
            border: 2px solid #6272A4;
            color: #8BE9FD;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .alphabet-btn:hover {
            border-color: #BD93F9;
            background: #282A36;
            transform: translateY(-2px);
        }

        .alphabet-btn.active {
            background: #BD93F9;
            color: #282A36;
            border-color: #BD93F9;
        }

        .alphabet-btn.all {
            background: #FF79C6;
            color: #282A36;
            border-color: #FF79C6;
            padding: 8px 20px;
        }

        .alphabet-btn.all:hover {
            background: #FF5555;
            border-color: #FF5555;
        }

        .list-info {
            text-align: center;
            padding: 40px 20px;
            color: #8BE9FD;
            font-style: italic;
        }

        /* Styles pour les fichiers */
        .files-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #6272A4;
        }

        .upload-area {
            background: #44475A;
            border: 2px dashed #6272A4;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #BD93F9;
            background: #282A36;
        }

        .upload-area.dragover {
            border-color: #50FA7B;
            background: #282A36;
        }

        .upload-input {
            display: none;
        }

        .upload-label {
            cursor: pointer;
            color: #8BE9FD;
            font-size: 1.1em;
        }

        .upload-hint {
            color: #6272A4;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .file-card {
            background: #44475A;
            border: 2px solid #6272A4;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .file-card:hover {
            border-color: #BD93F9;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(189, 147, 249, 0.3);
        }

        .file-preview {
            width: 100%;
            height: 150px;
            background: #282A36;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .file-icon {
            font-size: 3em;
            color: #8BE9FD;
        }

        .file-name {
            color: #F8F8F2;
            font-size: 0.9em;
            word-break: break-word;
            margin-bottom: 5px;
        }

        .file-size {
            color: #6272A4;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            padding: 6px 10px;
            font-size: 12px;
            flex: 1;
        }

        .upload-progress {
            background: #44475A;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #282A36;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #50FA7B, #8BE9FD);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #282A36;
            font-weight: bold;
            font-size: 0.8em;
        }

        /* Modal de visualisation */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            max-width: 95%;
            max-height: 95%;
            width: 1400px;
            background: #282A36;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(189, 147, 249, 0.5);
        }

        .modal-header {
            background: #44475A;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #6272A4;
        }

        .modal-title {
            color: #FF79C6;
            font-size: 1.4em;
            font-weight: bold;
        }

        .modal-close {
            background: #FF5555;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.3em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #FF6E67;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 0;
            max-height: calc(95vh - 80px);
            overflow: auto;
            background: #1a1c24;
        }

        .modal-image {
            width: 100%;
            height: auto;
            min-height: 500px;
            max-height: calc(95vh - 80px);
            object-fit: contain;
            background: #1a1c24;
        }

        .modal-document {
            width: 100%;
            height: calc(95vh - 80px);
            min-height: 600px;
            border: none;
            background: white;
        }

        .modal-text {
            background: #44475A;
            color: #F8F8F2;
            padding: 30px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 500px;
            max-height: calc(95vh - 80px);
            overflow: auto;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .modal-unsupported {
            text-align: center;
            padding: 60px 40px;
            color: #8BE9FD;
        }

        .modal-unsupported-icon {
            font-size: 5em;
            margin-bottom: 30px;
        }

        .modal-video-container {
            padding: 20px;
            background: #1a1c24;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
        }

        .modal-video {
            max-width: 100%;
            max-height: calc(95vh - 120px);
            width: auto;
            height: auto;
        }

        .modal-audio-container {
            padding: 60px 40px;
            text-align: center;
            background: #44475A;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .export-menu {
            background: #44475A;
            border: 2px solid #50FA7B;
            border-radius: 8px;
            padding: 20px;
            margin-top: 10px;
            display: none;
        }

        .export-menu.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .export-btn {
            background: #282A36;
            border: 2px solid #8BE9FD;
            color: #8BE9FD;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
        }

        .export-btn:hover {
            background: #8BE9FD;
            color: #282A36;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(139, 233, 253, 0.4);
        }

        .export-btn-icon {
            font-size: 2em;
            display: block;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .clients-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }

            .files-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .modal-content {
                max-width: 98%;
                max-height: 98%;
                width: auto;
            }

            .modal-body {
                max-height: calc(98vh - 70px);
            }

            .modal-image,
            .modal-document,
            .modal-video {
                max-height: calc(98vh - 70px);
            }

            .modal-text {
                padding: 15px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Gestion de Clients - Base de donn√©es</h1>

        <div id="statusMessage"></div>

        <div class="card">
            <h2>‚ûï Ajouter un nouveau client</h2>
            <form id="clientForm">
                <div class="form-group">
                    <label for="nom">Nom complet *</label>
                    <input type="text" id="nom" required placeholder="Jean Dupont">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="jean.dupont@email.com">
                </div>
                <div class="form-group">
                    <label for="telephone">T√©l√©phone</label>
                    <input type="tel" id="telephone" placeholder="06 12 34 56 78">
                </div>
                <div class="form-group">
                    <label for="notes">Notes / Informations</label>
                    <textarea id="notes" placeholder="Mot de passe: ******&#10;Serveur: 192.168.1.10&#10;IP: 10.0.0.5&#10;Acc√®s: admin&#10;Notes: Client VIP depuis 2023"></textarea>
                    <div class="note-hint">üí° Vous pouvez enregistrer : mots de passe, adresses IP, serveurs, acc√®s, etc.</div>
                </div>
                <button type="submit" class="btn" id="submitBtn">Ajouter le client</button>
            </form>
        </div>

        <div class="card">
            <div class="stats" id="stats">
                <div class="stat-box">
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">Clients enregistr√©s</div>
                </div>
            </div>

            <h2>üë• Liste des clients</h2>
            
            <div class="alphabet-filters" id="alphabetFilters">
                <!-- Les filtres seront g√©n√©r√©s par JavaScript -->
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Rechercher un client...">
            </div>
            <div class="clients-list" id="clientsList">
                <div class="list-info">
                    üí° Cliquez sur une lettre ci-dessus ou utilisez la recherche pour afficher vos clients
                </div>
            </div>
            <div class="client-details" id="clientDetails"></div>
        </div>

        <!--<div class="card">
            <h2>üíæ Export de la base de donn√©es</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn" onclick="showExportMenu()" style="background: #50FA7B; color: #282A36; font-size: 1.1em; padding: 15px 30px;">
                    üíæ Exporter toute la base de donn√©es
                </button>
            </div>

            <div class="export-menu" id="exportMenu">
                <h3 style="color: #50FA7B; margin-bottom: 15px; text-align: center;">Choisissez le format d'export</h3>
                <div class="export-options">
                    <button class="export-btn" onclick="exportData('json')">
                        <span class="export-btn-icon">üìã</span>
                        JSON<br><small style="opacity: 0.7;">Format brut</small>
                    </button>
                    <button class="export-btn" onclick="exportData('csv')">
                        <span class="export-btn-icon">üìä</span>
                        CSV<br><small style="opacity: 0.7;">Excel compatible</small>
                    </button>
                    <button class="export-btn" onclick="exportData('txt')">
                        <span class="export-btn-icon">üìÑ</span>
                        TXT<br><small style="opacity: 0.7;">Texte format√©</small>
                    </button>
                    <button class="export-btn" onclick="exportData('html')">
                        <span class="export-btn-icon">üåê</span>
                        HTML<br><small style="opacity: 0.7;">Page web</small>
                    </button>
                    <button class="export-btn" onclick="exportDataWithFiles()" style="border-color: #FF79C6; grid-column: span 2;">
                        <span class="export-btn-icon">üì¶</span>
                        Export complet (ZIP)<br><small style="opacity: 0.7;">Donn√©es + Fichiers</small>
                    </button>
                </div>
            </div>
        </div>
    </div>-->

    <!-- Modal de visualisation -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Visualisation</div>
                <button class="modal-close" onclick="closeModal()">‚úï Fermer</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Le contenu sera inject√© ici -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/clients';
        const UPLOAD_API_URL = '/upload';
        const FILES_API_URL = '/files';
        let editingId = null;
        let selectedClientId = null;
        let allClients = [];
        let currentFilter = null;
        let currentDisplayedClients = [];

        // Afficher un message de statut
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message ${isError ? 'error' : ''}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // G√©n√©rer les boutons alphab√©tiques
        function generateAlphabetFilters() {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const filtersDiv = document.getElementById('alphabetFilters');
            
            let html = '<button class="alphabet-btn all" onclick="window.filterByLetter(\'all\')">TOUS</button>';
            
            alphabet.forEach(letter => {
                html += `<button class="alphabet-btn" onclick="window.filterByLetter('${letter}')">${letter}</button>`;
            });
            
            filtersDiv.innerHTML = html;
        }

        // Filtrer par lettre
        window.filterByLetter = function(letter) {
            currentFilter = letter;
            
            document.querySelectorAll('.alphabet-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('searchInput').value = '';
            
            let filtered;
            if (letter === 'all') {
                filtered = allClients;
            } else {
                filtered = allClients.filter(client => 
                    client.nom.toUpperCase().startsWith(letter)
                );
            }
            
            displayClientsList(filtered);
        }

        // Charger tous les clients
        async function loadClients() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Erreur de chargement');
                allClients = await response.json();
                
                allClients.sort((a, b) => a.nom.localeCompare(b.nom, 'fr'));
                
                generateAlphabetFilters();
                
                document.getElementById('totalClients').textContent = allClients.length;
                
                document.getElementById('clientsList').innerHTML = `
                    <div class="list-info">
                        üí° Cliquez sur une lettre ci-dessus ou utilisez la recherche pour afficher vos clients
                    </div>
                `;
            } catch (error) {
                showStatus('‚ùå Erreur: Impossible de charger les clients. V√©rifiez que le serveur est d√©marr√©.', true);
                document.getElementById('clientsList').innerHTML = `
                    <div class="empty-state">
                        <p style="color: #FF5555;">‚ö†Ô∏è Erreur de connexion √† la base de donn√©es</p>
                        <p>Assurez-vous que le serveur JSON est d√©marr√© avec: npm start</p>
                    </div>
                `;
            }
        }

        // Ajouter ou modifier un client
        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;

            const client = {
                nom: document.getElementById('nom').value,
                email: document.getElementById('email').value,
                telephone: document.getElementById('telephone').value,
                notes: document.getElementById('notes').value,
                dateAjout: editingId ? undefined : new Date().toLocaleDateString('fr-FR')
            };

            try {
                let response;
                if (editingId) {
                    response = await fetch(`${API_URL}/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({...client, id: editingId, dateAjout: allClients.find(c => c.id === editingId)?.dateAjout})
                    });
                    showStatus('‚úÖ Client modifi√© avec succ√®s !');
                } else {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(client)
                    });
                    showStatus('‚úÖ Client ajout√© avec succ√®s !');
                }

                if (!response.ok) throw new Error('Erreur de sauvegarde');

                editingId = null;
                document.getElementById('submitBtn').textContent = 'Ajouter le client';
                this.reset();
                
                document.getElementById('clientDetails').classList.remove('show');
                selectedClientId = null;
                
                await loadClients();
                
                document.getElementById('clientsList').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showStatus('‚ùå Erreur lors de la sauvegarde du client', true);
            } finally {
                submitBtn.disabled = false;
            }
        });

        // Afficher la liste des clients (boutons)
        function displayClientsList(clients, title = null) {
            const clientsList = document.getElementById('clientsList');

            currentDisplayedClients = clients;

            document.getElementById('totalClients').textContent = allClients.length;

            if (clients.length === 0) {
                clientsList.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <p>Aucun client trouv√© ${title ? 'pour cette recherche' : ''}.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            if (title) {
                html += `<div style="color: #8BE9FD; margin-bottom: 15px; font-weight: bold; text-align: center;">${title} (${clients.length} r√©sultat${clients.length > 1 ? 's' : ''})</div>`;
            }

            html += clients.map(client => `
                <button class="client-button ${selectedClientId === client.id ? 'active' : ''}" onclick="window.showClientDetails('${client.id}')">
                    <span>${escapeHtml(client.nom)}</span>
                    <span class="client-arrow">‚ñ∂</span>
                </button>
            `).join('');
            
            clientsList.innerHTML = html;
        }

        // Afficher les d√©tails d'un client
        window.showClientDetails = async function(id) {
            console.log('showClientDetails appel√© avec id:', id);
            try {
                const url = `${API_URL}/${id}`;
                console.log('Fetching:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) throw new Error('Erreur de chargement');
                
                const client = await response.json();
                console.log('Client charg√©:', client);
                
                selectedClientId = id;
                
                if (currentDisplayedClients.length > 0) {
                    displayClientsList(currentDisplayedClients);
                }
                
                const detailsDiv = document.getElementById('clientDetails');
                console.log('Details div trouv√©:', detailsDiv);
                
                detailsDiv.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-title">${escapeHtml(client.nom)}</div>
                        <div class="detail-actions">
                            <button class="btn btn-small" onclick="window.exportSingleClient('${client.id}')" style="background: #50FA7B; color: #282A36;">üíæ Exporter</button>
                            <button class="btn btn-small btn-edit" onclick="window.editClient('${client.id}')">‚úèÔ∏è Modifier</button>
                            <button class="btn btn-small btn-delete" onclick="window.deleteClient('${client.id}')">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                    ${client.email ? `<div class="client-info"><strong>üìß Email:</strong> ${escapeHtml(client.email)}</div>` : ''}
                    ${client.telephone ? `<div class="client-info"><strong>üì± T√©l√©phone:</strong> ${escapeHtml(client.telephone)}</div>` : ''}
                    <div class="client-info"><strong>üìÖ Ajout√© le:</strong> ${client.dateAjout || 'N/A'}</div>
                    ${client.notes ? `
                        <div style="margin-top: 20px;">
                            <span class="notes-label">üìù Notes / Informations:</span>
                            <div class="client-notes">${escapeHtml(client.notes)}</div>
                        </div>
                    ` : ''}
                    
                    <div class="files-section">
                        <h3>üìÅ Fichiers et Documents</h3>
                        
                        <div class="upload-area" id="uploadArea-${client.id}">
                            <input type="file" id="fileInput-${client.id}" class="upload-input" multiple onchange="window.handleFileSelect('${client.id}', event)">
                            <label for="fileInput-${client.id}" class="upload-label">
                                üì§ Cliquez pour uploader des fichiers ou glissez-d√©posez ici
                            </label>
                            <div class="upload-hint">Tous types de fichiers accept√©s (Max 50MB par fichier)</div>
                            <div class="upload-progress" id="uploadProgress-${client.id}">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill-${client.id}" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="files-grid" id="filesGrid-${client.id}">
                            <div class="loading">Chargement des fichiers...</div>
                        </div>
                    </div>
                `;
                
                detailsDiv.classList.add('show');
                console.log('D√©tails affich√©s');
                
                // Charger les fichiers du client
                loadClientFiles(client.id);
                
                // Ajouter le drag & drop
                setupDragDrop(client.id);
                
                detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                console.error('Erreur dans showClientDetails:', error);
                showStatus('‚ùå Erreur lors du chargement du client', true);
            }
        }

        // Charger les fichiers d'un client
        async function loadClientFiles(clientId) {
            try {
                const response = await fetch(`${FILES_API_URL}/${clientId}`);
                if (!response.ok) throw new Error('Erreur de chargement des fichiers');
                
                const data = await response.json();
                displayClientFiles(clientId, data.files);
            } catch (error) {
                console.error('Erreur chargement fichiers:', error);
                document.getElementById(`filesGrid-${clientId}`).innerHTML = '<div class="list-info">Aucun fichier pour le moment</div>';
            }
        }

        // Afficher les fichiers d'un client
        function displayClientFiles(clientId, files) {
            const filesGrid = document.getElementById(`filesGrid-${clientId}`);
            
            if (!files || files.length === 0) {
                filesGrid.innerHTML = '<div class="list-info">Aucun fichier pour le moment</div>';
                return;
            }
            
            filesGrid.innerHTML = files.map(file => {
                const extension = file.originalname.split('.').pop().toLowerCase();
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(extension);
                const fileSize = formatFileSize(file.size);
                
                // Choisir l'ic√¥ne en fonction du type de fichier
                let fileIcon = 'üìÑ'; // Par d√©faut
                if (isImage) fileIcon = 'üñºÔ∏è';
                else if (extension === 'pdf') fileIcon = 'üìï';
                else if (['doc', 'docx'].includes(extension)) fileIcon = 'üìò';
                else if (['xls', 'xlsx'].includes(extension)) fileIcon = 'üìó';
                else if (['ppt', 'pptx'].includes(extension)) fileIcon = 'üìô';
                else if (['txt', 'rtf'].includes(extension)) fileIcon = 'üìù';
                else if (extension === 'pages') fileIcon = 'üìÑ';
                else if (extension === 'numbers') fileIcon = 'üî¢';
                else if (extension === 'keynote') fileIcon = 'üìä';
                else if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) fileIcon = 'üóúÔ∏è';
                else if (['mp4', 'avi', 'mov', 'webm'].includes(extension)) fileIcon = 'üé¨';
                else if (['mp3', 'wav', 'ogg', 'm4a'].includes(extension)) fileIcon = 'üéµ';
                else if (['json', 'xml', 'yaml', 'yml'].includes(extension)) fileIcon = 'üîß';
                else if (['py', 'js', 'java', 'cpp', 'c', 'php', 'rb'].includes(extension)) fileIcon = 'üíª';
                else if (['html', 'css'].includes(extension)) fileIcon = 'üåê';
                
                return `
                    <div class="file-card">
                        <div class="file-preview">
                            ${isImage 
                                ? `<img src="${file.path}" alt="${escapeHtml(file.originalname)}">`
                                : `<div class="file-icon">${fileIcon}</div>`
                            }
                        </div>
                        <div class="file-name">${escapeHtml(file.originalname)}</div>
                        <div class="file-size">${fileSize}</div>
                        <div class="file-actions">
                            <button class="btn btn-small btn-icon btn-edit" onclick="window.viewFile('${file.path}', '${escapeHtml(file.originalname)}')">üëÅÔ∏è</button>
                            <a href="${file.path}" download class="btn btn-small btn-icon" style="background: #50FA7B; color: #282A36; text-decoration: none; display: flex; align-items: center; justify-content: center;">‚¨áÔ∏è</a>
                            <button class="btn btn-small btn-icon btn-delete" onclick="window.deleteFile('${clientId}', '${file.filename}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // G√©rer la s√©lection de fichiers
        window.handleFileSelect = async function(clientId, event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            for (let file of files) {
                await uploadFile(clientId, file);
            }
            
            // R√©initialiser l'input
            event.target.value = '';
        }

        // Upload un fichier
        async function uploadFile(clientId, file) {
            const progressDiv = document.getElementById(`uploadProgress-${clientId}`);
            const progressFill = document.getElementById(`progressFill-${clientId}`);
            
            progressDiv.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${UPLOAD_API_URL}/${clientId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Erreur upload');
                
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                
                showStatus('‚úÖ Fichier upload√© avec succ√®s !');
                
                // Recharger les fichiers
                setTimeout(() => {
                    loadClientFiles(clientId);
                    progressDiv.style.display = 'none';
                }, 500);
                
            } catch (error) {
                console.error('Erreur upload:', error);
                showStatus('‚ùå Erreur lors de l\'upload du fichier', true);
                progressDiv.style.display = 'none';
            }
        }

        // Supprimer un fichier
        window.deleteFile = async function(clientId, filename) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce fichier ?')) return;
            
            try {
                const response = await fetch(`${FILES_API_URL}/${clientId}/${filename}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Erreur suppression');
                
                showStatus('‚úÖ Fichier supprim√© avec succ√®s !');
                loadClientFiles(clientId);
                
            } catch (error) {
                console.error('Erreur suppression fichier:', error);
                showStatus('‚ùå Erreur lors de la suppression du fichier', true);
            }
        }

        // Setup drag & drop
        function setupDragDrop(clientId) {
            const uploadArea = document.getElementById(`uploadArea-${clientId}`);
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragover');
                }, false);
            });
            
            uploadArea.addEventListener('drop', async (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                for (let file of files) {
                    await uploadFile(clientId, file);
                }
            }, false);
        }

        // Formater la taille de fichier
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Fonction pour √©chapper le HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modifier un client
        window.editClient = async function(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`);
                if (!response.ok) throw new Error('Erreur de chargement');
                
                const client = await response.json();
                document.getElementById('nom').value = client.nom;
                document.getElementById('email').value = client.email || '';
                document.getElementById('telephone').value = client.telephone || '';
                document.getElementById('notes').value = client.notes || '';
                editingId = id;
                
                document.getElementById('submitBtn').textContent = 'Modifier le client';
                
                document.getElementById('clientForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showStatus('‚ùå Erreur lors du chargement du client', true);
            }
        }

        // Supprimer un client
        window.deleteClient = async function(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce client ?')) return;

            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Erreur de suppression');

                showStatus('‚úÖ Client supprim√© avec succ√®s !');
                
                document.getElementById('clientDetails').classList.remove('show');
                selectedClientId = null;
                
                await loadClients();
            } catch (error) {
                showStatus('‚ùå Erreur lors de la suppression du client', true);
            }
        }

        // Recherche
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm !== '') {
                document.querySelectorAll('.alphabet-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                currentFilter = 'search';
            }
            
            if (searchTerm === '') {
                document.getElementById('clientsList').innerHTML = `
                    <div class="list-info">
                        üí° Cliquez sur une lettre ci-dessus ou utilisez la recherche pour afficher vos clients
                    </div>
                `;
                document.getElementById('clientDetails').classList.remove('show');
                selectedClientId = null;
                return;
            }
            
            if (searchTerm.length < 2) {
                document.getElementById('clientsList').innerHTML = `
                    <div class="list-info">
                        ‚å®Ô∏è Tapez au moins 2 caract√®res pour rechercher...
                    </div>
                `;
                return;
            }
            
            let filteredClients = allClients.filter(client => 
                client.nom.toLowerCase().includes(searchTerm) ||
                (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                (client.telephone && client.telephone.includes(searchTerm)) ||
                (client.notes && client.notes.toLowerCase().includes(searchTerm))
            );
            
            displayClientsList(filteredClients, `R√©sultats de recherche : "${e.target.value}"`);
            
            if (selectedClientId && !filteredClients.find(c => c.id === selectedClientId)) {
                document.getElementById('clientDetails').classList.remove('show');
                selectedClientId = null;
            }
        });

        // Charger les clients au d√©marrage
        loadClients();

        // Fonction pour visualiser un fichier
        window.viewFile = async function(filePath, fileName) {
            const modal = document.getElementById('viewModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = fileName;
            
            // D√©terminer le type de fichier
            const extension = fileName.split('.').pop().toLowerCase();
            
            // Images
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(extension)) {
                modalBody.innerHTML = `<img src="${filePath}" alt="${fileName}" class="modal-image">`;
            }
            // PDF
            else if (extension === 'pdf') {
                modalBody.innerHTML = `<iframe src="${filePath}" class="modal-document"></iframe>`;
            }
            // Texte
            else if (['txt', 'log', 'md', 'json', 'xml', 'csv', 'rtf', 'yaml', 'yml', 'ini', 'conf'].includes(extension)) {
                try {
                    const response = await fetch(filePath);
                    const text = await response.text();
                    modalBody.innerHTML = `<div class="modal-text">${escapeHtml(text)}</div>`;
                } catch (error) {
                    modalBody.innerHTML = `
                        <div class="modal-unsupported">
                            <div class="modal-unsupported-icon">‚ùå</div>
                            <p>Impossible de charger le fichier texte</p>
                        </div>
                    `;
                }
            }
            // Documents Office et Apple (via Google Docs Viewer)
            else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'pages', 'numbers', 'keynote', 'odt', 'ods', 'odp'].includes(extension)) {
                const fullUrl = window.location.origin + filePath;
                modalBody.innerHTML = `<iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(fullUrl)}&embedded=true" class="modal-document"></iframe>`;
            }
            // Vid√©o
            else if (['mp4', 'webm', 'ogg'].includes(extension)) {
                modalBody.innerHTML = `
                    <div class="modal-video-container">
                        <video controls class="modal-video">
                            <source src="${filePath}" type="video/${extension}">
                            Votre navigateur ne supporte pas la lecture vid√©o.
                        </video>
                    </div>
                `;
            }
            // Audio
            else if (['mp3', 'wav', 'ogg'].includes(extension)) {
                modalBody.innerHTML = `
                    <div class="modal-audio-container">
                        <div style="font-size: 6em; margin-bottom: 30px;">üéµ</div>
                        <div style="color: #8BE9FD; font-size: 1.2em; margin-bottom: 20px;">${fileName}</div>
                        <audio controls style="width: 80%; max-width: 600px;">
                            <source src="${filePath}" type="audio/${extension}">
                            Votre navigateur ne supporte pas la lecture audio.
                        </audio>
                    </div>
                `;
            }
            // Non support√©
            else {
                modalBody.innerHTML = `
                    <div class="modal-unsupported">
                        <div class="modal-unsupported-icon">üìÑ</div>
                        <p>Aper√ßu non disponible pour ce type de fichier</p>
                        <p style="color: #6272A4; margin-top: 10px;">Extension: .${extension}</p>
                        <p style="margin-top: 20px;">
                            <a href="${filePath}" download class="btn">‚¨áÔ∏è T√©l√©charger le fichier</a>
                        </p>
                    </div>
                `;
            }
            
            modal.classList.add('show');
            
            // Fermer avec Escape
            document.addEventListener('keydown', handleEscapeKey);
        }

        // Fermer la modal
        function closeModal() {
            const modal = document.getElementById('viewModal');
            modal.classList.remove('show');
            document.removeEventListener('keydown', handleEscapeKey);
        }

        // G√©rer la touche Escape
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        }

        // Fermer la modal en cliquant √† l'ext√©rieur
        document.getElementById('viewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Afficher/masquer le menu d'export
        function showExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
        }

        // Exporter les donn√©es
        async function exportData(format) {
            try {
                // Charger tous les clients
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Erreur de chargement');
                const clients = await response.json();

                if (clients.length === 0) {
                    showStatus('‚ùå Aucun client √† exporter', true);
                    return;
                }

                let content = '';
                let filename = '';
                let mimeType = '';

                const date = new Date().toISOString().split('T')[0];

                switch(format) {
                    case 'json':
                        content = JSON.stringify(clients, null, 2);
                        filename = `clients-${date}.json`;
                        mimeType = 'application/json';
                        break;

                    case 'csv':
                        // En-t√™tes CSV
                        content = 'Nom,Email,T√©l√©phone,Notes,Date d\'ajout\n';
                        // Donn√©es
                        clients.forEach(client => {
                            const nom = escapeCsv(client.nom);
                            const email = escapeCsv(client.email || '');
                            const telephone = escapeCsv(client.telephone || '');
                            const notes = escapeCsv(client.notes || '');
                            const dateAjout = escapeCsv(client.dateAjout || '');
                            content += `${nom},${email},${telephone},${notes},${dateAjout}\n`;
                        });
                        filename = `clients-${date}.csv`;
                        mimeType = 'text/csv;charset=utf-8;';
                        break;

                    case 'txt':
                        content = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                        content += '              BASE DE DONN√âES CLIENTS\n';
                        content += `              Export du ${new Date().toLocaleDateString('fr-FR')}\n`;
                        content += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                        content += `Total : ${clients.length} client(s)\n\n`;
                        
                        clients.forEach((client, index) => {
                            content += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                            content += `CLIENT #${index + 1}\n`;
                            content += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                            content += `üë§ Nom       : ${client.nom}\n`;
                            content += `üìß Email     : ${client.email || 'Non renseign√©'}\n`;
                            content += `üì± T√©l√©phone : ${client.telephone || 'Non renseign√©'}\n`;
                            content += `üìÖ Ajout√© le : ${client.dateAjout || 'N/A'}\n\n`;
                            
                            if (client.notes) {
                                content += `üìù NOTES :\n`;
                                content += `‚îå${'‚îÄ'.repeat(57)}‚îê\n`;
                                const noteLines = client.notes.split('\n');
                                noteLines.forEach(line => {
                                    content += `‚îÇ ${line.padEnd(56)}‚îÇ\n`;
                                });
                                content += `‚îî${'‚îÄ'.repeat(57)}‚îò\n`;
                            }
                            content += '\n\n';
                        });
                        
                        content += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                        content += '                     FIN DE L\'EXPORT\n';
                        content += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                        
                        filename = `clients-${date}.txt`;
                        mimeType = 'text/plain;charset=utf-8;';
                        break;

                    case 'html':
                        content = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Clients - ${date}</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #282A36;
            color: #F8F8F2;
            padding: 40px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #44475A;
            padding: 30px;
            border-radius: 10px;
        }
        h1 {
            color: #FF79C6;
            text-align: center;
            margin-bottom: 30px;
        }
        .stats {
            background: #282A36;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid #BD93F9;
        }
        .client {
            background: #282A36;
            border: 2px solid #6272A4;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }
        .client-name {
            color: #FF79C6;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .client-info {
            margin-bottom: 10px;
        }
        .label {
            color: #8BE9FD;
            font-weight: bold;
        }
        .notes {
            background: #44475A;
            padding: 15px;
            border-left: 4px solid #50FA7B;
            margin-top: 15px;
            white-space: pre-wrap;
            color: #F1FA8C;
        }
        @media print {
            body {
                background: white;
                color: black;
            }
            .container {
                background: white;
            }
            .client {
                border: 2px solid #ccc;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Base de donn√©es clients</h1>
        <div class="stats">
            <strong>Export du ${new Date().toLocaleDateString('fr-FR')}</strong><br>
            Total : ${clients.length} client(s)
        </div>
`;
                        
                        clients.forEach((client, index) => {
                            content += `
        <div class="client">
            <div class="client-name">#${index + 1} - ${escapeHtml(client.nom)}</div>
            <div class="client-info"><span class="label">üìß Email:</span> ${escapeHtml(client.email || 'Non renseign√©')}</div>
            <div class="client-info"><span class="label">üì± T√©l√©phone:</span> ${escapeHtml(client.telephone || 'Non renseign√©')}</div>
            <div class="client-info"><span class="label">üìÖ Ajout√© le:</span> ${client.dateAjout || 'N/A'}</div>
            ${client.notes ? `<div class="notes"><strong>üìù Notes:</strong><br>${escapeHtml(client.notes)}</div>` : ''}
        </div>
`;
                        });
                        
                        content += `
    </div>
</body>
</html>`;
                        filename = `clients-${date}.html`;
                        mimeType = 'text/html;charset=utf-8;';
                        break;
                }

                // T√©l√©charger le fichier
                const blob = new Blob([content], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showStatus(`‚úÖ Export ${format.toUpperCase()} r√©ussi ! (${filename})`);
                
            } catch (error) {
                console.error('Erreur export:', error);
                showStatus('‚ùå Erreur lors de l\'export', true);
            }
        }

        // √âchapper les caract√®res CSV
        function escapeCsv(str) {
            if (str === null || str === undefined) return '';
            str = String(str);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        // Exporter les donn√©es avec les fichiers (ZIP) - VERSION SERVEUR
        async function exportDataWithFiles() {
            try {
                showStatus('‚è≥ Pr√©paration de l\'export complet (peut prendre quelques minutes pour les gros volumes)...', false);
                
                // Appeler la route serveur qui g√©n√®re le ZIP
                const response = await fetch('/export-all', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/zip'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erreur r√©ponse:', response.status, errorText);
                    throw new Error(`Erreur ${response.status}: ${errorText}`);
                }
                
                showStatus('‚è≥ T√©l√©chargement de l\'archive en cours...', false);
                
                // R√©cup√©rer le blob
                const blob = await response.blob();
                
                console.log('Taille du blob re√ßu:', blob.size, 'bytes');
                
                if (blob.size < 1000) {
                    throw new Error('Le fichier ZIP est trop petit, il y a eu une erreur');
                }
                
                // Cr√©er le lien de t√©l√©chargement
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                const date = new Date().toISOString().split('T')[0];
                link.download = `export-complet-clients-${date}.zip`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showStatus(`‚úÖ Export complet r√©ussi ! T√©l√©chargement termin√© (${(blob.size / 1024 / 1024).toFixed(2)} MB).`);

            } catch (error) {
                console.error('Erreur export complet:', error);
                showStatus(`‚ùå Erreur: ${error.message}`, true);
            }
        }

        // Exporter un seul client avec ses fichiers (ZIP)
        window.exportSingleClient = async function(clientId) {
            try {
                showStatus('‚è≥ Pr√©paration de l\'export...', false);
                
                // Charger les donn√©es du client
                const response = await fetch(`${API_URL}/${clientId}`);
                if (!response.ok) throw new Error('Erreur de chargement');
                const client = await response.json();

                // Cr√©er le ZIP
                const zip = new JSZip();
                const date = new Date().toISOString().split('T')[0];
                const safeName = client.nom
                    .replace(/[<>:"/\\|?*]/g, '_')
                    .replace(/\s+/g, '_')
                    .trim();

                // Ajouter les donn√©es du client en JSON
                zip.file('client.json', JSON.stringify(client, null, 2));

                // Ajouter les donn√©es du client en TXT format√©
                let txtContent = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                txtContent += '              FICHE CLIENT\n';
                txtContent += `              Export du ${new Date().toLocaleDateString('fr-FR')}\n`;
                txtContent += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                
                txtContent += `üë§ Nom       : ${client.nom}\n`;
                txtContent += `üìß Email     : ${client.email || 'Non renseign√©'}\n`;
                txtContent += `üì± T√©l√©phone : ${client.telephone || 'Non renseign√©'}\n`;
                txtContent += `üìÖ Ajout√© le : ${client.dateAjout || 'N/A'}\n`;
                txtContent += `üÜî ID        : ${client.id}\n\n`;
                
                if (client.notes) {
                    txtContent += `üìù NOTES :\n`;
                    txtContent += `‚îå${'‚îÄ'.repeat(57)}‚îê\n`;
                    const noteLines = client.notes.split('\n');
                    noteLines.forEach(line => {
                        txtContent += `‚îÇ ${line.padEnd(56)}‚îÇ\n`;
                    });
                    txtContent += `‚îî${'‚îÄ'.repeat(57)}‚îò\n`;
                }
                
                txtContent += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                
                zip.file('client.txt', txtContent);

                // Charger les fichiers du client
                let totalFiles = 0;
                try {
                    const filesResponse = await fetch(`${FILES_API_URL}/${client.id}`);
                    if (filesResponse.ok) {
                        const filesData = await filesResponse.json();
                        
                        if (filesData.files && filesData.files.length > 0) {
                            // Cr√©er un dossier pour les fichiers
                            const filesFolder = zip.folder('fichiers');
                            
                            // Cr√©er un fichier index des fichiers
                            let filesIndex = `FICHIERS DU CLIENT: ${client.nom}\n`;
                            filesIndex += `${'‚ïê'.repeat(60)}\n\n`;
                            filesIndex += `Nombre de fichiers: ${filesData.files.length}\n\n`;
                            filesIndex += `Liste des fichiers:\n`;
                            filesIndex += `${'‚îÄ'.repeat(60)}\n`;
                            
                            filesData.files.forEach((f, i) => {
                                filesIndex += `${i + 1}. ${f.originalname} (${formatFileSize(f.size)})\n`;
                            });
                            
                            filesFolder.file('_liste_fichiers.txt', filesIndex);
                            
                            // T√©l√©charger et ajouter chaque fichier
                            for (const file of filesData.files) {
                                try {
                                    showStatus(`‚è≥ T√©l√©chargement de ${file.originalname}...`, false);
                                    const fileResponse = await fetch(file.path);
                                    if (fileResponse.ok) {
                                        const fileBlob = await fileResponse.blob();
                                        filesFolder.file(file.originalname, fileBlob);
                                        totalFiles++;
                                    }
                                } catch (fileError) {
                                    console.error(`Erreur fichier ${file.filename}:`, fileError);
                                }
                            }
                        }
                    }
                } catch (filesError) {
                    console.error('Erreur chargement fichiers:', filesError);
                }

                // Cr√©er un README
                const readme = `EXPORT CLIENT: ${client.nom}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìÖ Date d'export : ${new Date().toLocaleString('fr-FR')}
üë§ Client        : ${client.nom}
üìß Email         : ${client.email || 'N/A'}
üì± T√©l√©phone     : ${client.telephone || 'N/A'}

üìÅ CONTENU DE L'ARCHIVE :
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ README.txt    : Ce fichier
‚Ä¢ client.json   : Donn√©es du client (format JSON)
‚Ä¢ client.txt    : Fiche client lisible (format TXT)
‚Ä¢ fichiers/     : Dossier contenant les fichiers du client (${totalFiles})

üîß UTILISATION :
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. Extraire l'archive ZIP
2. Consulter client.txt pour les informations
3. Les fichiers upload√©s sont dans le dossier fichiers/

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
                
                zip.file('README.txt', readme);

                showStatus('‚è≥ G√©n√©ration du fichier ZIP...', false);

                // G√©n√©rer et t√©l√©charger le ZIP
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 9 }
                });

                const url = window.URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${safeName}-${date}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showStatus(`‚úÖ Export r√©ussi ! ${client.nom} + ${totalFiles} fichier(s)`);

            } catch (error) {
                console.error('Erreur export client:', error);
                showStatus('‚ùå Erreur lors de l\'export du client', true);
            }
        }
    </script>
</body>
</html>
